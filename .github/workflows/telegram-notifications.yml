# .github/workflows/telegram-notifications.yml
name: ðŸŽ‚ Daily Romantic Notifications

on:
  schedule:
    # Runs at 10:00 AM UTC every day
    - cron: '0 10 * * *'
  workflow_dispatch:  # Allows manual run

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'  # This enables caching
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci  # Uses package-lock.json for exact versions
          
      - name: ðŸ” Debug information
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Current directory: $(pwd)"
          echo "Files:"
          ls -la
          echo ""
          echo "Checking package.json..."
          if [ -f "package.json" ]; then
            echo "âœ… package.json exists"
          else
            echo "âŒ package.json missing"
            exit 1
          fi
          
          if [ -f "package-lock.json" ]; then
            echo "âœ… package-lock.json exists"
          else
            echo "âš ï¸  package-lock.json missing, generating..."
            npm install
          fi
          
      - name: ðŸ“‹ Check secrets (safe)
        run: |
          echo "Checking environment variables..."
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "âœ… TELEGRAM_BOT_TOKEN is set"
          else
            echo "âŒ TELEGRAM_BOT_TOKEN is not set"
            echo "Please add it in: Settings â†’ Secrets â†’ TELEGRAM_BOT_TOKEN"
            exit 1
          fi
          
          if [ -n "${{ secrets.APP_BASE_URL }}" ]; then
            echo "âœ… APP_BASE_URL is set"
            echo "URL: ${{ secrets.APP_BASE_URL }}"
          else
            echo "âŒ APP_BASE_URL is not set"
            echo "Please add it in: Settings â†’ Secrets â†’ APP_BASE_URL"
            exit 1
          fi
          
      - name: ðŸ¤– Run Telegram Bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          COUNTDOWN_START_DATE: ${{ secrets.COUNTDOWN_START_DATE || '2024-01-01' }}
        run: |
          echo "Starting Telegram bot..."
          node telegram-bot.js
          
      - name: âœ… Success log
        if: success()
        run: echo "ðŸŽ‰ Daily notifications sent successfully at $(date)"
        
      - name: ðŸ“ Create run log
        if: always()
        run: |
          echo "Workflow run completed at: $(date)" >> workflow-log.txt
          echo "Status: ${{ job.status }}" >> workflow-log.txt
          echo "Run ID: ${{ github.run_id }}" >> workflow-log.txt
          echo "Run Number: ${{ github.run_number }}" >> workflow-log.txt
          
      - name: ðŸ“¤ Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-logs
          path: workflow-log.txt
